# Техническая передача проекта (Handover)

## Текущее состояние
Реализован MVP цикл быстрой загрузки данных (Full Refresh) из Google Sheets в Supabase. CDC и инкрементальная загрузка временно отложены в пользу скорости запуска Web App.

## Реализованные компоненты
1. `get_headers.py`: Извлекает заголовки из листов, указанных в `sources.yml`. Результат сохраняется в `headers.json`.
2. `deploy_schema.py`: Автоматически создает таблицы в Supabase на основе `headers.json`. Колонки нормализуются (slugify).
3. `fast_loader.py`: Основной скрипт загрузки. Делает `TRUNCATE` + `copy_records_to_table`. Использует асинхронный драйвер `asyncpg`.
4. `check_db.py`: Утилита для проверки фактической схемы в БД.

## Критичные настройки
- **PgBouncer**: Supabase использует PgBouncer. Для работы `asyncpg` обязательно указывать `statement_cache_size=0` при подключении, иначе возникнут ошибки подготовленных выражений.
- **Порт**: Используется транзакционный пулер на порту `6543`.
- **Кодировка**: Все колонки в БД созданы в нижнем регистре. Русские названия заголовков успешно превращаются в слаги (например, "Дата" -> `дата`).

## Инструкции по дебагу
1. Проверка подключения: `python3 check_db.py`.
2. Повторная загрузка: `python3 fast_loader.py`.
3. Логи: Ошибки `asyncpg` обычно связаны с несовпадением типов (все колонки сейчас `text`) или проблемами пулера.

## Следующие шаги
- Интеграция с Web App (репозиторий `pl_crm_from_gas`).
- Настройка RLS (Row Level Security) в Supabase, если требуется.
- Возврат к CDC-логике (хеширование строк), когда объем данных вырастет и Full Refresh станет медленным.
