# –†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ –∏ —Å–∏—Å—Ç–µ–º–µ (System Manual)
## –ï–¥–∏–Ω—ã–π ETL-–∫–æ–Ω–≤–µ–π–µ—Ä: Google Sheets ‚Üí Supabase

**–í–µ—Ä—Å–∏—è:** 2.0  
**–î–∞—Ç–∞:** 18.01.2026  
**–û—Ö–≤–∞—Ç:** `pl-etl-core` + `pk_cdc_gas`

---

## –ß–∞—Å—Ç—å 1: –û–±–∑–æ—Ä —Å–∏—Å—Ç–µ–º—ã

–°–∏—Å—Ç–µ–º–∞ —Å–æ—Å—Ç–æ–∏—Ç –∏–∑ –¥–≤—É—Ö —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤:

| –ö–æ–º–ø–æ–Ω–µ–Ω—Ç | –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|:---|:---|:---|
| **pk_cdc_gas** | Google Apps Script | –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Sheets: –≥–µ–Ω–µ—Ä–∞—Ü–∏—è UUID, —Ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ, –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ |
| **pl-etl-core** | Python 3.10+ / asyncpg | –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ, –≤–∞–ª–∏–¥–∞—Ü–∏—è, CDC, –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Supabase |

### –ü–æ—Ç–æ–∫ –¥–∞–Ω–Ω—ã—Ö (Data Flow)
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê      ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Google Sheets  ‚îÇ ‚îÄ‚îÄ‚îÄ‚ñ∏ ‚îÇ  pk_cdc_gas     ‚îÇ ‚îÄ‚îÄ‚îÄ‚ñ∏ ‚îÇ  Sheets (Ready) ‚îÇ
‚îÇ  (Raw Data)     ‚îÇ      ‚îÇ  (ID + Hash)    ‚îÇ      ‚îÇ  (With Metadata)‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò      ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                           ‚îÇ
                         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê               ‚îÇ
                         ‚îÇ  pl-etl-core    ‚îÇ ‚óÇ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                         ‚îÇ  (ELT Pipeline) ‚îÇ
                         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                  ‚îÇ
           ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
           ‚ñº                      ‚ñº                      ‚ñº
    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê         ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
    ‚îÇ staging.*  ‚îÇ   ‚îÄ‚îÄ‚îÄ‚ñ∏  ‚îÇ public.*   ‚îÇ   ‚îÄ‚îÄ‚îÄ‚ñ∏  ‚îÇ analytics.*‚îÇ
    ‚îÇ (Raw)      ‚îÇ         ‚îÇ (Clean)    ‚îÇ         ‚îÇ (Marts)    ‚îÇ
    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò         ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## –ß–∞—Å—Ç—å 2: pk_cdc_gas (Google Apps Script)

### 2.1 –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ
–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å –ë–î:
*   –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö `record_id` (UUID –∏–ª–∏ PREFIX).
*   –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `content_hash` (SHA-256) –¥–ª—è CDC.
*   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ `created_at`, `updated_at`, `updated_by`.

### 2.2 –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

| –§—É–Ω–∫—Ü–∏—è | –¢—Ä–∏–≥–≥–µ—Ä | –û–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|:---|
| `onEdit(e)` | –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π | –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ —è—á–µ–π–∫–∏ ‚Äî –æ–±–Ω–æ–≤–ª—è–µ—Ç hash, updated_at, updated_by |
| `runMassProcessing()` | –ú–µ–Ω—é | –ú–∞—Å—Å–æ–≤–æ–µ –ø—Ä–∏—Å–≤–æ–µ–Ω–∏–µ ID –∏ —Ö–µ—à–µ–π –¥–ª—è –≤—Å–µ—Ö —Å—Ç—Ä–æ–∫ |
| `recalculateHashes()` | –ú–µ–Ω—é | –ü–µ—Ä–µ—Å—á–µ—Ç —Ö–µ—à–µ–π –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏—è ID |
| `findTableContext(sheet)` | –í–Ω—É—Ç—Ä–µ–Ω–Ω—è—è | Discovery: –ø–æ–∏—Å–∫ —Å—Ç—Ä–æ–∫–∏ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –ø–æ –∏–º–µ–Ω–∏ `record_id` |

### 2.3 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`CFG`)
```javascript
const CFG = {
  pkHeader: 'record_id',
  hashHeader: 'content_hash',
  createdHeader: 'created_at',
  updatedHeader: 'updated_at',
  updatedByHeader: 'updated_by',
  requiredCols: [1, 2, 3],    // A, B, C –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
  idType: 'UUID',             // –∏–ª–∏ 'PREFIX'
  prefix: 'sa',               // –¥–ª—è PREFIX: sa_000001
  discoveryScanLimit: 10      // —Å–∫–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –ø–æ–∏—Å–∫–∞ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤
};
```

### 2.4 Discovery Mode
–°–∫—Ä–∏–ø—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç** —Å—Ç—Ä–æ–∫—É –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤, —Å–∫–∞–Ω–∏—Ä—É—è –ø–µ—Ä–≤—ã–µ 10 —Å—Ç—Ä–æ–∫ –≤ –ø–æ–∏—Å–∫–∞—Ö –∫–æ–ª–æ–Ω–∫–∏ `record_id`.

> **–ó–∞—â–∏—Ç–∞:** –ï—Å–ª–∏ –Ω–∞–π–¥–µ–Ω–æ –¥–≤–∞ —Å—Ç–æ–ª–±—Ü–∞ —Å –æ–¥–∏–Ω–∞–∫–æ–≤—ã–º –∏–º–µ–Ω–µ–º ‚Äî –≤—ã–±—Ä–æ—Å –æ—à–∏–±–∫–∏.

### 2.5 –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å
*   `LockService` –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –≥–æ–Ω–∫—É –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–π –æ–±—Ä–∞–±–æ—Ç–∫–µ.
*   –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ `record_id` **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è**.
*   –ù–µ–≤–∞–ª–∏–¥–Ω—ã–µ UUID –ª–æ–≥–∏—Ä—É—é—Ç—Å—è, –Ω–æ –Ω–µ —Å—Ç–∏—Ä–∞—é—Ç—Å—è.

---

## –ß–∞—Å—Ç—å 3: pl-etl-core (Python Pipeline)

### 3.1 –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞
```bash
python -m src.main [OPTIONS]
```

| –§–ª–∞–≥ | –û–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|
| `--dry-run` | –ü–æ–∫–∞–∑–∞—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –±–µ–∑ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è |
| `--full-refresh` | TRUNCATE + INSERT (–ø–æ–ª–Ω–∞—è –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞) |
| `--scope` | `current` / `historical` / `all` |
| `--skip-load` | –¢–æ–ª—å–∫–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è |
| `--skip-export` | –ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å —ç–∫—Å–ø–æ—Ä—Ç –≤–∏—Ç—Ä–∏–Ω |

### 3.2 –§–∞–∑—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è

#### –§–∞–∑–∞ 1: Extraction (`extractor.py`)
1.  –ê—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –≤ Google API (Service Account).
2.  –ß—Ç–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö (`ws.get(range)`).
3.  –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ (`slugify` + `column_mapping`).
4.  –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Å—Ç—Ä–æ–∫ (padding –¥–æ –¥–ª–∏–Ω—ã –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤).

#### –§–∞–∑–∞ 2: Validation (`validator.py`)
1.  –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ –∏–∑ `src/contracts/{entity}.json`.
2.  –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥–æ–π —Å—Ç—Ä–æ–∫–∏:
    *   `required` –ø–æ–ª—è
    *   –¢–∏–ø—ã –¥–∞–Ω–Ω—ã—Ö (`string`, `integer`, `money`, `date`, `time`)
3.  **–ü–æ—Ä–æ–≥–∏ –æ—à–∏–±–æ–∫:**
    *   > 20 –æ—à–∏–±–æ–∫ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É ‚Üí **ABORT**
    *   > 5 –æ—à–∏–±–æ–∫ –≤ –æ–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–µ ‚Üí **ABORT**

#### –§–∞–∑–∞ 3: CDC (`cdc_processor.py`)
1.  –í—ã—á–∏—Å–ª–µ–Ω–∏–µ `row_hash` (MD5 –æ—Ç –∫–æ–Ω—Ç–µ–Ω—Ç–∞ —Å—Ç—Ä–æ–∫–∏).
2.  –°—Ä–∞–≤–Ω–µ–Ω–∏–µ —Å —Ö–µ—à–∞–º–∏ –≤ –ë–î (`SELECT pk, __row_hash FROM table`).
3.  –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è: `INSERT` / `UPDATE` / `DELETE` / `UNCHANGED`.

#### –§–∞–∑–∞ 4: Loading (`loader.py`)
*   **Upsert Mode:** `INSERT ... ON CONFLICT DO UPDATE` (—Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–æ–Ω–Ω–æ).
*   **Replace Mode:** `TRUNCATE` + `COPY`.

#### –§–∞–∑–∞ 5: Transformation (`transformer.py`)
*   –ó–∞–ø—É—Å–∫ SQL-—Å–∫—Ä–∏–ø—Ç–æ–≤ –∏–∑ `src/db/sql/`.
*   –ü–æ—Ä—è–¥–æ–∫: `clients` ‚Üí `schedule` ‚Üí `sales`.

#### –§–∞–∑–∞ 6: Export (`exporter.py`)
*   –≠–∫—Å–ø–æ—Ä—Ç SQL-–ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏–π (–≤–∏—Ç—Ä–∏–Ω) –æ–±—Ä–∞—Ç–Ω–æ –≤ Google Sheets.

### 3.3 –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`sources.yml`)

**–ö–ª—é—á–µ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã:**
```yaml
sheets:
  - id: clients_cur
    gid: "389044927"
    target_table: stg_gsheets.clients_cur
    pk: "record_id"          # Primary Key
    mode: upsert             # –∏–ª–∏ replace
    column_mapping:
      content_hash: sheet_content_hash
      created_at: sheet_created_at
```

---

## –ß–∞—Å—Ç—å 4: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ –ª–∏–º–∏—Ç—ã

| –ü–∞—Ä–∞–º–µ—Ç—Ä | –ó–Ω–∞—á–µ–Ω–∏–µ | –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ |
|:---|:---|:---|
| **–¢–∞–±–ª–∏—Ü –≤ –ø—Ä–æ–µ–∫—Ç–µ** | ‚â§ 20 | –ó–∞—â–∏—Ç–∞ –æ—Ç –∫–≤–æ—Ç API |
| **–°—Ç—Ä–æ–∫ –Ω–∞ —Ç–∞–±–ª–∏—Ü—É** | ‚â§ 100 000 | –ó–∞—â–∏—Ç–∞ –æ—Ç OOM |
| **–û—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏** | ‚â§ 20 / —Ç–∞–±–ª–∏—Ü–∞ | –ú–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å % |
| **Retry –Ω–∞ 429** | 3 –ø–æ–ø—ã—Ç–∫–∏ | –≠–∫—Å–ø–æ–Ω–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–π backoff |

---

## –ß–∞—Å—Ç—å 5: –ì–∏–±—Ä–∏–¥–Ω–∞—è —Å—Ç—Ä–∞—Ç–µ–≥–∏—è (Token Passing)

**–°—Ç–∞—Ç—É—Å:** üü° –í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ (Backlog).

**–ö–æ–Ω—Ü–µ–ø—Ü–∏—è:**
*   –ó–∞–ø–∏—Å—å –∏–º–µ–µ—Ç –≤–ª–∞–¥–µ–ª—å—Ü–∞ (`source_system: sheets | webapp`).
*   –ü—Ä–∏ `source_system = webapp` ‚Äî –∫—Ä–∏—Ç–∏—á–Ω—ã–µ –ø–æ–ª—è –±–ª–æ–∫–∏—Ä—É—é—Ç—Å—è –≤ Sheets.
*   –ö–æ–Ω—Ñ–ª–∏–∫—Ç—ã —Å–æ–∑–¥–∞—é—Ç "–¢–∏–∫–µ—Ç" –¥–ª—è —Ä—É—á–Ω–æ–≥–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.

**–ß—Ç–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ:**
*   [x] –í–∞–ª–∏–¥–∞—Ü–∏—è UUID –≤ GAS.
*   [ ] –ü—Ä–æ–≤–µ—Ä–∫–∞ `source_system` –≤ onEdit.
*   [ ] –õ–æ–≥–∏–∫–∞ —Ç–∏–∫–µ—Ç–æ–≤ –≤ ETL.

---

## –ß–∞—Å—Ç—å 6: –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ (–ø—Ä–∏–º–µ—Ä: Bitrix)
1.  –°–æ–∑–¥–∞—Ç—å `src/etl/bitrix_extractor.py`:
    ```python
    class BitrixExtractor:
        async def extract(self, entity: str) -> Tuple[List[str], List[List[Any]]]:
            # –í—ã–∑–æ–≤ REST API Bitrix24
            # –í–æ–∑–≤—Ä–∞—Ç (col_names, rows)
    ```
2.  –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å –≤ `pipeline.py`.
3.  –î–æ–±–∞–≤–∏—Ç—å —Å–µ–∫—Ü–∏—é –≤ `sources.yml`.

### –î–æ–±–∞–≤–ª–µ–Ω–∏–µ SQL-—Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
1.  –°–æ–∑–¥–∞—Ç—å `src/db/sql/transform_new.sql`.
2.  –î–æ–±–∞–≤–∏—Ç—å –≤ `transformer.py`:
    ```python
    files_to_run = [..., 'transform_new.sql']
    ```

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã –∏ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.*
