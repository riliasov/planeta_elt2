# Архитектура источников данных (Data Sources)

## Два потока данных

ELT-пайплайн работает с двумя независимыми источниками:

| Суффикс | Полное название | Описание | Частота обновления |
|---------|-----------------|----------|-------------------|
| `_cur` | Current (текущие) | Оперативные данные | Near-realtime / ежедневно |
| `_hst` | Historical (исторические) | Архивные данные | Ежемесячно / по требованию |

## Триггеры обновления

### Current (`_cur`)

**Источник**: Активные Google Sheets с текущими операциями.

**Стратегия**: CDC (Change Data Capture) по хешу строки.

```
1. При каждом запуске:
   - Вычислить hash каждой строки в Sheets
   - Сравнить с hash в БД
   - INSERT новые, UPDATE изменённые, DELETE удалённые
```

**Таблицы**:
- `clients_cur` → `public.clients`
- `sales_cur` → `public.sales`
- `trainings_cur` → `public.schedule`
- `expenses_cur` → `public.expenses`

### Historical (`_hst`)

**Источник**: Архивные Google Sheets с историческими данными.

**Стратегия**: Full Refresh или Append-only.

```
1. При запуске (редко):
   - TRUNCATE staging таблицу
   - Загрузить все данные заново
   - Или: только добавить новые записи (append)
```

**Таблицы**:
- `clients_hst` → для аналитики / архива
- `sales_hst` → для отчётов
- `trainings_hst` → для статистики

## Связь с CRM

```
┌─────────────────────────────────────────────────────────┐
│                    Google Sheets                        │
├─────────────────────────────────────────────────────────┤
│  Current (операции)  │  Historical (архив)              │
└──────────┬───────────┴────────────┬─────────────────────┘
           │                        │
           ▼                        ▼
┌──────────────────────┐   ┌──────────────────────┐
│     *_cur таблицы    │   │     *_hst таблицы    │
│   (staging слой)     │   │   (staging слой)     │
└──────────┬───────────┘   └──────────┬───────────┘
           │                          │
           ▼                          ▼
┌──────────────────────┐   ┌──────────────────────┐
│   public.clients     │   │   Аналитика / BI     │
│   public.sales       │   │   (отдельная тема)   │
│   public.schedule    │   │                      │
└──────────────────────┘   └──────────────────────┘
           │
           ▼
┌──────────────────────┐
│     CRM Web App      │
│  (только чтение)     │
└──────────────────────┘
```

## CDC: Двухуровневая проверка

### Уровень 1: Google Sheets (GAS)
- UUID генерируется при создании записи
- Hash строки вычисляется при изменении
- Колонка `__row_hash` хранит текущий hash

### Уровень 2: База данных (ELT)
- При загрузке сравниваем `__row_hash` из Sheets с hash в БД
- Если hash изменился → UPDATE
- Если строка новая → INSERT
- Если строка исчезла из Sheets → DELETE (hard delete) или пометка (soft delete)

## Важные соглашения

1. **legacy_id**: UUID из GAS, используется для связи записей при миграции
2. **__row_hash**: MD5 hash содержимого строки, вычисляется в Python
3. **_row_index**: Номер строки в Sheets для отладки
4. **_loaded_at**: Timestamp загрузки в БД
