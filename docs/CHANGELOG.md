# CHANGELOG

## [0.5.0] — 2026-01-11 (Security Audit & Refactoring)

### Добавлено
- **Security Validation**: Строгая проверка идентификаторов в `DataLoader` (защита от SQL Injection).
- **Test Coverage**: Внедрены unit-тесты безопасности (`tests/test_loader_security.py`) и E2E тесты пайплайна (`tests/test_pipeline_e2e.py`).
- **TableProcessor**: Выделенный класс для изоляции логики обработки таблиц (Extract -> Validate -> Load).

### Изменено
- **Refactoring Validator**: Полный отказ от ручной валидации типов в пользу `Pydantic v2` и динамических моделей.
- **Refactoring Pipeline**: `ELTPipeline` переведен в режим чистого оркестратора.
- **Refactoring Loader**: Устранено дублирование кода подготовки строк (методы `_prepare_row`, `_validate_identifier`).
- **Data Integrity**: Исправлена ошибка хеширования для валютных полей.

## [0.4.0] — 2026-01-11 (PK CDC Integration)

### Добавлено
- **PK CDC Integration**: Переход на использование стабильных `record_id` (UUID) в качестве Primary Key вместо нестабильных хешей строк.
- **Metadata Support**: Добавлены и настроены колонки `sheet_created_at`, `sheet_updated_at`, `sheet_content_hash` и `sheet_updated_by`.
- **Column Mapping**: Внедрена поддержка `column_mapping` в `sources.yml` для гибкого сопоставления заголовков листов с колонками БД.
- **Hybrid Strategy**: Разработана и задокументирована стратегия "Token Passing" для безопасной совместной работы Google Sheets и будущего Web App.
- **GAS Validation**: В скрипт `pk_cdc_master.gs` добавлена строгая валидация UUID для защиты внешних ID.
- **Documentation**: Добавлен `PROJECT_ANALYSIS.md` (полный аудит проекта) и `state_diagrams.md` (диаграммы состояний).

### Изменено
- **Pipeline Logic**: Загрузчик и CDC-процессор адаптированы для работы с динамическими PK.
- **Configuration**: Все источники в `sources.yml` переведены на использование `record_id` и расширенные диапазоны `A:ZZ`.

## [0.3.0] — 2026-01-11

### Добавлено
- **DWH Слоеная Архитектура**: Внедрены схемы `raw`, `staging`, `references` и `analytics` для разделения ответственности.
- **DataMartExporter**: Модуль для экспорта SQL-представлений напрямую в Google Sheets.
- **Продвинутая очистка (Data Cleaning)**: Автоматическая нормализация данных (nbsp, пробелы, форматы чисел) при загрузке в `staging`.
- **Deep Scan & Cleanup**: Полная инспекция БД, удаление устаревших схем (`core`, `etl`) и таблиц (`leads`, `tasks`).
- **Схема-мапа**: Автоматически генерируемая карта всей структуры БД (`supabase_schema_map.md`).

### Исправлено
- **Логика Loader**: Исправлена критическая ошибка целевой схемы (использование `schema_name` вместо `schema` в `asyncpg`).
- **Регрессионные тесты**: Добавлено покрытие для проверки изоляции схем (`tests/test_loader_schema.py`).
- **Soft Delete**: Сброс флагов `is_deleted` при повторном появлении записей в источнике.

## [0.2.0] — 2026-01-10

### Добавлено
- **Поддержка транслитерации в валидаторе**: Теперь валидатор автоматически сопоставляет русские названия полей из контрактов с транслитерированными ключами из Google Sheets.
- **Регрессионные тесты**: Добавлены тесты для проверки маппинга сложных заголовков и обработки переименований колонок (`tests/test_validator.py`).
- **Лимит ошибок валидации**: Пайплайн теперь останавливается, если количество ошибок в таблице превышает 30.
- **Сценарий очистки логов**: Скрипт `scripts/clean_logs.py` для удаления устаревших записей в `validation_logs`.
- **Workflow Local Run**: Файл `.agent/workflows/local-run.md` для автоматизации развертывания.

### Изменено
- **Рефакторинг структуры**: Проект полностью переехал в `src/` с единой точкой входа в `src/main.py`. Старые скрипты перемещены в `legacy/`.
- **Обновление документации**: Актуализированы `README.md` и `docs/HANDOVER.md`.

## [0.1.0] — 2026-01-08

### Добавлено
- Инициализация проекта `pl-etl-core`.
- Базовая логика CDC для Google Sheets -> Supabase.
- Интеграция Streamlit дашборда.
- Поддержка Soft Delete и хеширования строк.
