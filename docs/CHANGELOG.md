# CHANGELOG

## [0.3.0] — 2026-01-11

### Добавлено
- **DWH Слоеная Архитектура**: Внедрены схемы `raw`, `staging`, `references` и `analytics` для разделения ответственности.
- **DataMartExporter**: Модуль для экспорта SQL-представлений напрямую в Google Sheets.
- **Продвинутая очистка (Data Cleaning)**: Автоматическая нормализация данных (nbsp, пробелы, форматы чисел) при загрузке в `staging`.
- **Deep Scan & Cleanup**: Полная инспекция БД, удаление устаревших схем (`core`, `etl`) и таблиц (`leads`, `tasks`).
- **Схема-мапа**: Автоматически генерируемая карта всей структуры БД (`supabase_schema_map.md`).

### Исправлено
- **Логика Loader**: Исправлена критическая ошибка целевой схемы (использование `schema_name` вместо `schema` в `asyncpg`).
- **Регрессионные тесты**: Добавлено покрытие для проверки изоляции схем (`tests/test_loader_schema.py`).
- **Soft Delete**: Сброс флагов `is_deleted` при повторном появлении записей в источнике.

## [0.2.0] — 2026-01-10

### Добавлено
- **Поддержка транслитерации в валидаторе**: Теперь валидатор автоматически сопоставляет русские названия полей из контрактов с транслитерированными ключами из Google Sheets.
- **Регрессионные тесты**: Добавлены тесты для проверки маппинга сложных заголовков и обработки переименований колонок (`tests/test_validator.py`).
- **Лимит ошибок валидации**: Пайплайн теперь останавливается, если количество ошибок в таблице превышает 30.
- **Сценарий очистки логов**: Скрипт `scripts/clean_logs.py` для удаления устаревших записей в `validation_logs`.
- **Workflow Local Run**: Файл `.agent/workflows/local-run.md` для автоматизации развертывания.

### Изменено
- **Рефакторинг структуры**: Проект полностью переехал в `src/` с единой точкой входа в `src/main.py`. Старые скрипты перемещены в `legacy/`.
- **Обновление документации**: Актуализированы `README.md` и `docs/HANDOVER.md`.

## [0.1.0] — 2026-01-08

### Добавлено
- Инициализация проекта `pl-etl-core`.
- Базовая логика CDC для Google Sheets -> Supabase.
- Интеграция Streamlit дашборда.
- Поддержка Soft Delete и хеширования строк.
