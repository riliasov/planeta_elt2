# –ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–µ–∫—Ç–∞: pk_cdc_gas

**–î–∞—Ç–∞:** 18.01.2026  
**–¢–∏–ø:** Google Apps Script (GAS)  
**–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ:** `/Users/rambook/Developer/pk_cdc_gas/`

---

## 1. –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ

–°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≤ Google Sheets –∫ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å Supabase:
*   –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ç–∞–±–∏–ª—å–Ω—ã—Ö –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ç–æ—Ä–æ–≤ (`record_id`).
*   –í—ã—á–∏—Å–ª–µ–Ω–∏–µ —Ö–µ—à–µ–π –∫–æ–Ω—Ç–µ–Ω—Ç–∞ (`content_hash`) –¥–ª—è CDC.
*   –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–∫–∏–Ω–≥ –∏–∑–º–µ–Ω–µ–Ω–∏–π (`updated_at`, `updated_by`).

---

## 2. –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞

| –§–∞–π–ª | –û–ø–∏—Å–∞–Ω–∏–µ |
|:---|:---|
| `pk_cdc_master.gs` | –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫—Ä–∏–ø—Ç (283 —Å—Ç—Ä–æ–∫–∏) |
| `README.md` | –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ |
| `CONTEXT.md` | –¢–µ—Ö–Ω–∏—á–µ—Å–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã |
| `DATA_CONTRACTS.md` | –°–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–ª–æ–Ω–æ–∫ |

---

## 3. –ö–ª—é—á–µ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏

### 3.1 Discovery Mode (`findTableContext`)
–°–∫—Ä–∏–ø—Ç **–∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞—Ö–æ–¥–∏—Ç** —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü—ã:
*   –°–∫–∞–Ω–∏—Ä—É–µ—Ç –ø–µ—Ä–≤—ã–µ **5 —Å—Ç—Ä–æ–∫** (–ª–∏–º–∏—Ç —É–º–µ–Ω—å—à–µ–Ω –¥–ª—è —Å–∫–æ—Ä–æ—Å—Ç–∏).
*   –ü–æ–∏—Å–∫ –∏–¥–µ—Ç **—Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö** (–Ω–∞—á–∏–Ω–∞—è —Å 5-–π —Å—Ç—Ä–æ–∫–∏).
*   –ò—â–µ—Ç –∫–æ–ª–æ–Ω–∫—É —Å –∏–º–µ–Ω–µ–º `record_id`.
*   **–í–∞–∂–Ω–æ**: –í—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–∏—Å—Ç–µ–º–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏ (`content_hash`, `updated_at` –∏ –¥—Ä.) –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è **–Ω–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–æ–∫–µ**, —á—Ç–æ –∏ `record_id`.

**–ó–∞—â–∏—Ç–∞:** –ï—Å–ª–∏ `record_id` –Ω–∞–π–¥–µ–Ω, –Ω–æ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥—Ä—É–≥–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –∫–æ–ª–æ–Ω–∫–∏, —Å–∫—Ä–∏–ø—Ç –≤—ã–¥–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏—Ö –ø–æ–ª–µ–π –∏ –Ω–æ–º–µ—Ä–∞ —Å—Ç—Ä–æ–∫–∏.

### 3.2 Identity Management
–î–≤–∞ —Ä–µ–∂–∏–º–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ID (—Ç–æ–ª—å–∫–æ —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫):
| –†–µ–∂–∏–º | –§–æ—Ä–º–∞—Ç | –ü—Ä–∏–º–µ—Ä |
|:---|:---|:---|
| UUID | `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` | `a1b2c3d4-...` |
| PREFIX | `{prefix}_{number}` | `sa_000001` |

**–ü—Ä–∞–≤–∏–ª–æ:** –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ ID **–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—ã–≤–∞—é—Ç—Å—è**.

### 3.3 Hash-based CDC
*   –ê–ª–≥–æ—Ä–∏—Ç–º: SHA-256.
*   –•–µ—à–∏—Ä—É—é—Ç—Å—è –¥–∞–Ω–Ω—ã–µ –≤—Å–µ—Ö –∫–æ–ª–æ–Ω–æ–∫, **–∫—Ä–æ–º–µ –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö**.
*   **–ò—Å–∫–ª—é—á–∞–µ–º—ã–µ –∫–æ–ª–æ–Ω–∫–∏**: `record_id`, `content_hash`, `created_at`, `updated_at`, `updated_by`.
*   –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏–≤–æ–¥—è—Ç—Å—è –∫ –Ω–∏–∂–Ω–µ–º—É —Ä–µ–≥–∏—Å—Ç—Ä—É, –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã —É–¥–∞–ª—è—é—Ç—Å—è.

### 3.4 –†–µ–∂–∏–º —Ä–∞–±–æ—Ç—ã: Manual (HST)
–°–∫—Ä–∏–ø—Ç —Ä–∞–±–æ—Ç–∞–µ—Ç **–∏—Å–∫–ª—é—á–∏—Ç–µ–ª—å–Ω–æ –≤ —Ä—É—á–Ω–æ–º —Ä–µ–∂–∏–º–µ** —á–µ—Ä–µ–∑ –º–µ–Ω—é "üöÄ Sheet Service (HST)".
*   **onEdit —É–¥–∞–ª–µ–Ω**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ç—Ä–µ–∫–∏–Ω–≥ –æ—Ç–∫–ª—é—á–µ–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏—Ö –¥–∞–Ω–Ω—ã—Ö.
*   **–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ñ–ª–æ—É**: –ü–æ—Å–ª–µ –≤–Ω–µ—Å–µ–Ω–∏—è –ø—Ä–∞–≤–æ–≤ –≤ –∏—Å—Ç–æ—Ä–∏—á–µ—Å–∫–∏–µ –¥–∞–Ω–Ω—ã–µ, –∑–∞–ø—É—Å—Ç–∏—Ç—å "–ü–µ—Ä–µ—Å—á–∏—Ç–∞—Ç—å —Ö–µ—à–∏" –∏–ª–∏ "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ".

---

## 4. –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (`CFG`)

```javascript
const CFG = {
  pkHeader: 'record_id',
  hashHeader: 'content_hash',
  createdHeader: 'created_at',
  updatedHeader: 'updated_at',
  updatedByHeader: 'updated_by',
  requiredCols: [1, 2, 3],    // –ö–æ–ª–æ–Ω–∫–∏ A, B, C –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã
  idType: 'UUID',
  prefix: 'sa',
  pad: 6,
  timeZone: "Asia/Yekaterinburg",
  discoveryScanLimit: 10
};
```

---

## 5. –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

| –ú–µ—Ö–∞–Ω–∏–∑–º | –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ |
|:---|:---|
| `LockService` | –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –≥–æ–Ω–∫–∏ –¥–∞–Ω–Ω—ã—Ö |
| UUID Validation | –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö ID |
| No Overwrite | –ó–∞—â–∏—Ç–∞ –æ—Ç –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∏ ID |

---

## 6. –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å pl-etl-core

**–°–≤—è–∑—å:** `pk_cdc_gas` –ø–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ ‚Üí `pl-etl-core` –∏—Ö –∑–∞–≥—Ä—É–∂–∞–µ—Ç.

**–ö–æ–Ω—Ç—Ä–∞–∫—Ç:**
*   –ö–æ–ª–æ–Ω–∫–∞ `record_id` ‚Üí `pk` –≤ `sources.yml`.
*   –ö–æ–ª–æ–Ω–∫–∞ `content_hash` ‚Üí `sheet_content_hash` (—á–µ—Ä–µ–∑ `column_mapping`).

---

## 7. –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É–ª—É—á—à–µ–Ω–∏—é

1.  **–î–æ–±–∞–≤–∏—Ç—å –≤–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä**: –ü–æ–¥—Å–≤–µ—á–∏–≤–∞—Ç—å —Å—Ç—Ä–æ–∫–∏ —Å –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–º–∏ UUID.
2.  **–õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ**: –û—Ç–ø—Ä–∞–≤–ª—è—Ç—å –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –æ—à–∏–±–∫–∏ –≤ Google Cloud Logging.
3.  **Hybrid Strategy**: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–æ–≤–µ—Ä–∫—É `source_system` –≤ `onEdit` –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.

---

*–î–æ–∫—É–º–µ–Ω—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞ –∫–æ–¥–æ–≤–æ–π –±–∞–∑—ã.*
