# AI-CONTEXT FIRST

## AI-RULES (ЗАПРЕЩЕНО РЕДАКТИРОВАТЬ БЕЗ ПРЯМОГО СОГЛАСИЯ ПОЛЬЗОВАТЕЛЯ)
- Агент обязан поддерживать этот README.md в актуальном состоянии (цель проекта, структура, зависимости, решения).
- Секция ## AI-RULES не изменяется и не удаляется без моего явного подтверждения.
- Все изменения кода — только через git-ветки, миграции с down-скриптами, конфиги вне кода.
- Агент обязан помогать с нуля создавать структуру, шаблоны, CI/CD, тесты, окружения.
- Мягкий dry: считаем risk = high при изменениях infra/migrations или схемы БД, при добавлении зависимостей, при изменении >100 строк данных/массовой обработке или при правке AI-RULES; если risk=low → apply, если risk=medium → short preview (unified diff + 1-line) + snapshot (обязательно включить git-контекст: HEAD, ветка, статус/diff), если risk=high → pause и ждать подтверждения владельца.
- Агент может предлагать дополнительные правила dry как `deviation` (причина, влияние, rollback) — они действуют только после явного подтверждения владельца или после merge PR с успешным CI.
- Формат логов: `{LEVEL} | {component} | {message}` (одна строка, русский язык)
- Docstrings и комментарии к функциям/классам — только русский, максимум 1 строка.
- Язык реализации: Python 3.11+, async где уместно.
- Перед любым крупным изменением (рефакторинг, миграции, новые зависимости) — обязательный план + ожидание подтверждения.
- Всё, что ниже `--- AGENT-MAY-EDIT-BELOW ---`, агент может свободно редактировать без подтверждения.

- **Минимальная и обязательная структура README.md (агент обязан создавать и поддерживать именно в таком порядке):**
  1. `# AI-CONTEXT FIRST` (первая строка файла)
  2. `## AI-RULES (...)` (эта секция, фиксированная)
  3. `--- AGENT-MAY-EDIT-BELOW ---` (разделитель, после него агент редактирует свободно)
  4. `## Цель проекта` (1–3 предложения, всегда актуально)
  5. `## Текущие задачи` (чек-лист с [ ] / [x])
  6. `## Ключевые зависимости` (список ключевых библиотек и версий)
  7. `## Структура проекта` (код-блок с tree-структурой корня проекта)
  8. `## Важные решения` — архитектурные выборы, причины отказа от альтернатив, известные ограничения.
  9. `## Известные проблемы` — баги, TODO, технический долг.
  10. `## Human-only (...)` (всё, что ниже — только для человека, агент НЕ читает и НЕ использует для задач)

--- AGENT-MAY-EDIT-BELOW ---

## Цель проекта
Синхронизация данных из Google Sheets в Supabase PostgreSQL для использования в Web App (pl_crm_from_gas).

## Текущий статус: ФАЗА 1 ЗАВЕРШЕНА ✅
- [x] Автоматическая генерация схемы БД на основе Google Sheets.
- [x] Быстрая загрузка данных (Full Refresh) с skip + log для битых строк.
- [x] Асинхронное подключение к Supabase (PgBouncer compatible).
- [x] Документация источников данных (_cur vs _hst).
- [x] CDC-логика (hash-сравнение) — модуль src/cdc.py.
- [x] Трансформация staging → public — transform_to_public.py.
- [x] Главный скрипт пайплайна — run_pipeline.py.

## Ключевые зависимости
- Python 3.11+
- gspread — работа с Google Sheets API
- asyncpg — высокопроизводительный асинхронный драйвер PostgreSQL
- python-dotenv — управление переменными окружения
- PyYAML — чтение конфигурации источников

## Структура проекта
```text
planeta_elt2/
├── src/                  # Исходный код (модули)
├── docs/                 # Документация
│   └── DATA_SOURCES.md   # Описание _cur vs _hst
├── secrets/              # JSON ключи (в .gitignore)
├── get_headers.py        # Сбор заголовков из Sheets
├── deploy_schema.py      # Развертывание таблиц в Supabase
├── fast_loader.py        # Full Refresh с skip + log
├── check_db.py           # Утилита проверки данных в БД
├── sources.yml           # Конфигурация листов и таблиц
├── HANDOVER.md           # Инструкция для тех. передачи
└── .env                  # Настройки подключения (в .gitignore)
```

## Быстрый старт
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt
python3 get_headers.py      # Собрать заголовки
python3 deploy_schema.py    # Создать таблицы
python3 fast_loader.py      # Загрузить данные
```

## Важные решения
- **Full Refresh + Skip/Log**: Битые строки пропускаются, не блокируют загрузку.
- **Два источника**: `_cur` (текущие) и `_hst` (исторические) — разные триггеры.
- **legacy_id**: UUID из GAS для связи с CRM-приложением.
- **PgBouncer**: Используется `statement_cache_size=0`.
- **Типы данных**: Пока `text`, типизация на этапе трансформации.

## Известные проблемы
- **PgBouncer**: Не поддерживает Prepared Statements.
- **Русские заголовки**: Нормализуются в нижний регистр.

## Связь с CRM
CRM-приложение (`pl_crm_from_gas`) читает данные из `public.*` таблиц.
Схема БД определена в `pl_crm_from_gas/supabase/schema.sql` — это контракт.