# AI-CONTEXT FIRST

## AI-RULES (ЗАПРЕЩЕНО РЕДАКТИРОВАТЬ БЕЗ ПРЯМОГО СОГЛАСИЯ ПОЛЬЗОВАТЕЛЯ)
- Агент обязан поддерживать этот README.md в актуальном состоянии (цель проекта, структура, зависимости, решения).
- Секция ## AI-RULES не изменяется и не удаляется без моего явного подтверждения.
- Все изменения кода — только через git-ветки, миграции с down-скриптами, конфиги вне кода.
- Агент обязан помогать с нуля создавать структуру, шаблоны, CI/CD, тесты, окружения.
- Мягкий dry: считаем risk = high при изменениях infra/migrations или схемы БД, при добавлении зависимостей, при изменении >100 строк данных/массовой обработке или при правке AI-RULES; если risk=low → apply, если risk=medium → short preview (unified diff + 1-line) + snapshot (обязательно включить git-контекст: HEAD, ветка, статус/diff), если risk=high → pause и ждать подтверждения владельца.
- Агент может предлагать дополнительные правила dry как `deviation` (причина, влияние, rollback) — они действуют только после явного подтверждения владельца или после merge PR с успешным CI.
- Формат логов: `{LEVEL} | {component} | {message}` (одна строка, русский язык)
- Docstrings и комментарии к функциям/классам — только русский, максимум 1 строка.
- Язык реализации: Python 3.11+, async где уместно.
- Перед любым крупным изменением (рефакторинг, миграции, новые зависимости) — обязательный план + ожидание подтверждения.
- Всё, что ниже `--- AGENT-MAY-EDIT-BELOW ---`, агент может свободно редактировать без подтверждения.

- **Минимальная и обязательная структура README.md (агент обязан создавать и поддерживать именно в таком порядке):**
  1. `# AI-CONTEXT FIRST` (первая строка файла)
  2. `## AI-RULES (...)` (эта секция, фиксированная)
  3. `--- AGENT-MAY-EDIT-BELOW ---` (разделитель, после него агент редактирует свободно)
  4. `## Цель проекта` (1–3 предложения, всегда актуально)
  5. `## Текущие задачи` (чек-лист с [ ] / [x])
  6. `## Ключевые зависимости` (список ключевых библиотек и версий)
  7. `## Структура проекта` (код-блок с tree-структурой корня проекта)
  8. `## Важные решения` — архитектурные выборы, причины отказа от альтернатив, известные ограничения.
  9. `## Известные проблемы` — баги, TODO, технический долг.
  10. `## Human-only (...)` (всё, что ниже — только для человека, агент НЕ читает и НЕ использует для задач)

--- AGENT-MAY-EDIT-BELOW ---

## Цель проекта
Создать быструю MVP-систему для синхронизации данных из Google Sheets в Supabase PostgreSQL для немедленного использования в Web App.

## Текущий статус: MVP ЗАВЕРШЕН
- [x] Автоматическая генерация схемы БД на основе Google Sheets.
- [x] Реализована быстрая загрузка данных (Full Refresh) для ~21к строк.
- [x] Настроено асинхронное подключение к Supabase (PgBouncer compatible).

## Ключевые зависимости
- Python 3.11+
- gspread — работа с Google Sheets API
- asyncpg — высокопроизводительный асинхронный драйвер PostgreSQL
- python-dotenv — управление переменными окружения
- PyYAML — чтение конфигурации источников

## Структура проекта
```text
planeta_elt2/
├── src/                # Исходный код (в процессе миграции на MVP)
├── secrets/            # JSON ключи гугл-аккаунта (в .gitignore)
├── get_headers.py      # Сбор заголовков из Sheets
├── deploy_schema.py    # Развертывание таблиц в Supabase
├── fast_loader.py      # Скрипт Full Refresh загрузки
├── check_db.py         # Утилита проверки данных в БД
├── sources.yml         # Конфигурация соответствия листов и таблиц
├── HANDOVER.md         # Инструкция для тех. передачи
└── .env                # Настройки подключения (в .gitignore)
```

## Быстрый старт
1. Настройте `.env` на основе примера.
2. Подложите ключ в `secrets/google-service-account.json`.
3. Запустите цикл загрузки:
```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r requirements.txt # Создайте его из pyproject.toml
python3 get_headers.py
python3 deploy_schema.py
python3 fast_loader.py
```

## Важные решения
- **Full Refresh вместо CDC**: Для скорости MVP выбран метод полной перезаписи таблиц. Инкрементальная загрузка с хешами отложена.
- **PgBouncer**: Для работы через пулер Supabase (порт 6543) используется `statement_cache_size=0`.
- **Типы данных**: Все колонки импортированы как `text` для максимальной совместимости на этапе MVP.

## Известные проблемы
- **PgBouncer**: Не поддерживает Prepared Statements, что требует явного отключения кеша в коде.
- **Русские заголовки**: Нормализуются в нижний регистр, что может потребовать внимания при написании SQL-запросов.