# AI-CONTEXT FIRST

## AI-RULES (ЗАПРЕЩЕНО РЕДАКТИРОВАТЬ БЕЗ ПРЯМОГО СОГЛАСИЯ ПОЛЬЗОВАТЕЛЯ)
- Агент обязан поддерживать этот README.md в актуальном состоянии (цель проекта, структура, зависимости, решения).
- Секция ## AI-RULES не изменяется и не удаляется без моего явного подтверждения.
- Все изменения кода — только через git-ветки, миграции с down-скриптами, конфиги вне кода.
- Агент обязан помогать с нуля создавать структуру, шаблоны, CI/CD, тесты, окружения.
- Мягкий dry: считаем risk = high при изменениях infra/migrations или схемы БД, при добавлении зависимостей, при изменении >100 строк данных/массовой обработке или при правке AI-RULES; если risk=low → apply, если risk=medium → short preview (unified diff + 1-line) + snapshot (обязательно включить git-контекст: HEAD, ветка, статус/diff), если risk=high → pause и ждать подтверждения владельца.
- Агент может предлагать дополнительные правила dry как `deviation` (причина, влияние, rollback) — они действуют только после явного подтверждения владельца или после merge PR с успешным CI.
- Формат логов: `{LEVEL} | {component} | {message}` (одна строка, русский язык)
- Docstrings и комментарии к функциям/классам — только русский, максимум 1 строка.
- Язык реализации: Python 3.11+, async где уместно.
- Перед любым крупным изменением (рефакторинг, миграции, новые зависимости) — обязательный план + ожидание подтверждения.
- Всё, что ниже `--- AGENT-MAY-EDIT-BELOW ---`, агент может свободно редактировать без подтверждения.

- **Минимальная и обязательная структура README.md (агент обязан создавать и поддерживать именно в таком порядке):**
  1. `# AI-CONTEXT FIRST` (первая строка файла)
  2. `## AI-RULES (...)` (эта секция, фиксированная)
  3. `--- AGENT-MAY-EDIT-BELOW ---` (разделитель, после него агент редактирует свободно)
  4. `## Цель проекта` (1–3 предложения, всегда актуально)
  5. `## Текущие задачи` (чек-лист с [ ] / [x])
  6. `## Ключевые зависимости` (список ключевых библиотек и версий)
  7. `## Структура проекта` (код-блок с tree-структурой корня проекта)
  8. `## Важные решения` — архитектурные выборы, причины отказа от альтернатив, известные ограничения.
  9. `## Известные проблемы` — баги, TODO, технический долг.
  10. `## Human-only (...)` (всё, что ниже — только для человека, агент НЕ читает и НЕ использует для задач)

--- AGENT-MAY-EDIT-BELOW ---

## Цель проекта
Синхронизация данных из Google Sheets в Supabase PostgreSQL для CRM (pl_crm_from_gas).

## Текущий статус: ПОЛНОСТЬЮ ГОТОВ ✅
- [x] Full Refresh загрузка с skip + log
- [x] CDC (инкрементальная загрузка) — **по умолчанию**
- [x] Трансформация staging → public
- [x] GitHub Actions Scheduler (ежедневно)
- [x] 15 unit-тестов для CDC

## Ключевые зависимости
- Python 3.11+
- gspread, asyncpg, pyyaml, python-dotenv

## Структура проекта
```text
planeta_elt2/
├── src/cdc.py            # Модуль CDC (хеширование)
├── cdc_loader.py         # Инкрементальная загрузка
├── fast_loader.py        # Full Refresh
├── transform_to_public.py # Трансформация
├── run_pipeline.py       # Главный скрипт
├── .github/workflows/    # GitHub Actions
├── docs/                 # Документация
├── tests/                # Unit-тесты
└── sources.yml           # Конфигурация
```

## Использование
```bash
# CDC режим (по умолчанию)
python run_pipeline.py

# Full Refresh (первичная загрузка)
python run_pipeline.py --full-refresh

# Только трансформация
python run_pipeline.py --transform-only
```

## Scheduler
GitHub Actions запускает пайплайн ежедневно в 6:00 UTC.
Документация: [docs/SCHEDULER.md](docs/SCHEDULER.md)

## Связь с CRM
Схема: `pl_crm_from_gas/supabase/schema.sql`